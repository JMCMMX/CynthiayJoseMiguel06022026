<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ¬∑ Confirmaciones RSVP</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Lato:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --arena:#E7DCCB; --duna:#CDBDA7; --mar:#5AA7C7;
      --ok:#6fbf8a; --no:#d97c7c; --wait:#9a9a9a;
      --text:#2f2f2f; --card:rgba(255,255,255,.94);
      --shadow:0 18px 45px rgba(0,0,0,.12); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; padding:22px;
      font-family:"Lato",sans-serif; color:var(--text);
      background:radial-gradient(circle at top,#fff 0%,var(--arena) 48%,var(--duna) 100%);
    }
    .wrap{max-width:1250px;margin:auto}
    .top{
      background:var(--card); box-shadow:var(--shadow); border-radius:var(--radius);
      padding:22px 20px 18px; text-align:center; position:relative; overflow:hidden;
    }
    .top::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(135deg,rgba(90,167,199,.22),rgba(205,189,167,.14));
      opacity:.7; pointer-events:none;
    }
    .top>*{position:relative;z-index:1}

    .names{font-family:"Dancing Script",cursive;font-size:2.8rem;margin:0;color:var(--mar)}
    .subtitle{margin:6px 0 12px;letter-spacing:.18em;text-transform:uppercase;font-size:.85rem;color:rgba(47,47,47,.7)}

    .summary{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
      margin-top:12px;
    }
    .box{
      background:#fff; border:1px solid rgba(205,189,167,.9);
      border-radius:16px; padding:14px 14px 12px;
      box-shadow:0 10px 22px rgba(0,0,0,.07);
      text-align:left;
    }
    .box .label{font-size:.78rem;letter-spacing:.18em;text-transform:uppercase;color:rgba(47,47,47,.65)}
    .box .value{font-size:1.6rem;font-weight:900;margin-top:6px; line-height:1.05}
    .muted{color:rgba(47,47,47,.65)}
    .ok{color:var(--ok)} .no{color:var(--no)} .wait{color:var(--wait)}

    .progressWrap{margin-top:12px; background:#fff; border:1px solid rgba(205,189,167,.9); border-radius:16px; padding:12px 14px; box-shadow:0 10px 22px rgba(0,0,0,.07)}
    .progressRow{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .progressBar{height:12px; border-radius:999px; background:rgba(205,189,167,.35); overflow:hidden; margin-top:10px}
    .progressFill{height:100%; width:0%; background:linear-gradient(135deg, rgba(90,167,199,1), rgba(60,126,126,1)); border-radius:999px; transition:width .35s ease}
    .kpiLine{font-size:.9rem; color:rgba(47,47,47,.78)}

    .controls{
      margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    }
    input,select{
      padding:10px 14px; border-radius:12px; border:1px solid rgba(205,189,167,.95);
      background:#fff; outline:none; min-width:220px; font-size:.95rem;
    }
    .btn{
      padding:10px 18px; border-radius:999px; border:0;
      background:var(--mar); color:#fff; font-weight:900; cursor:pointer;
      box-shadow:0 12px 26px rgba(90,167,199,.35);
    }
    .btn.secondary{
      background:#fff; color:#444; border:1px solid rgba(205,189,167,.95);
      box-shadow:0 10px 22px rgba(0,0,0,.07);
    }
    .btn:hover{filter:brightness(.97)}

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(295px,1fr));
      gap:14px;
    }
    .card{
      background:var(--card);
      border-radius:16px;
      padding:14px 14px 12px;
      box-shadow:0 14px 32px rgba(0,0,0,.10);
      position:relative;
      border:1px solid rgba(205,189,167,.5);
    }
    .status{
      position:absolute; top:12px; right:12px;
      padding:6px 12px; border-radius:999px;
      font-size:.75rem; font-weight:900;
    }
    .status.ok{background:rgba(111,191,138,.18);color:var(--ok)}
    .status.no{background:rgba(217,124,124,.18);color:var(--no)}
    .status.wait{background:rgba(154,154,154,.18);color:var(--wait)}

    .open-badge{
      position:absolute; top:12px; left:12px;
      padding:6px 10px; border-radius:999px;
      font-size:.72rem; font-weight:900;
      background:rgba(231,220,203,.65);
      border:1px solid rgba(205,189,167,.9);
      color:#444;
    }

    .name{font-weight:900;font-size:1.05rem;margin:44px 0 6px; padding-right:90px;}
    .meta{font-size:.9rem;line-height:1.45;color:rgba(47,47,47,.78)}
    .small{margin-top:8px;font-size:.8rem;color:rgba(47,47,47,.65)}
    .tag{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid rgba(205,189,167,.9); background:#fff; font-weight:800; font-size:.74rem; letter-spacing:.08em; text-transform:uppercase; color:#555}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}

    details{
      margin-top:10px;
      background:rgba(255,255,255,.6);
      border:1px solid rgba(205,189,167,.55);
      border-radius:14px;
      padding:10px 12px;
    }
    summary{
      cursor:pointer;
      font-weight:900;
      color:#3f3f3f;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}
    .detailLabel{font-size:.78rem; letter-spacing:.16em; text-transform:uppercase; color:rgba(47,47,47,.65); margin-top:10px}
    .detailText{
      margin-top:6px; font-size:.9rem; color:rgba(47,47,47,.82);
      white-space:pre-wrap;
      line-height:1.45;
    }

    .empty,.error{
      margin-top:18px;background:var(--card);
      border-radius:var(--radius);padding:16px;text-align:center;box-shadow:var(--shadow);
    }
    .error{border:1px solid rgba(217,124,124,.4)}
    code{background:rgba(231,220,203,.55);padding:2px 6px;border-radius:8px}

    @media(max-width:480px){
      .names{font-size:2.3rem}
      .name{margin-top:48px}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <h1 class="names">Cynthia &amp; Jos√© Miguel</h1>
    <div class="subtitle">Panel administrador ¬∑ RSVP</div>

    <div class="summary">
      <div class="box">
        <div class="label">Invitaciones (tokens)</div>
        <div class="value"><span id="t_reg">‚Äî</span></div>
        <div class="small muted">Total de registros activos en ‚Äúinvitados‚Äù.</div>
      </div>

      <div class="box">
        <div class="label">Total de pases</div>
        <div class="value"><span id="t_pases">‚Äî</span></div>
        <div class="small muted">Suma de ‚Äúpases‚Äù (t√∫ + acompa√±antes).</div>
      </div>

      <div class="box">
        <div class="label">Pases confirmados</div>
        <div class="value ok" id="t_p_ok">‚Äî</div>
        <div class="small muted">Suma de pases con estatus Confirmado.</div>
      </div>

      <div class="box">
        <div class="label">Pases no asisten</div>
        <div class="value no" id="t_p_no">‚Äî</div>
        <div class="small muted">Suma de pases con estatus No asistir√°.</div>
      </div>

      <div class="box">
        <div class="label">Pases pendientes</div>
        <div class="value wait" id="t_p_wait">‚Äî</div>
        <div class="small muted">Suma de pases sin respuesta (o indeciso).</div>
      </div>

      <div class="box">
        <div class="label">Actividad</div>
        <div class="value"><span id="t_resp">‚Äî</span>/<span id="t_open">‚Äî</span></div>
        <div class="small muted">Respondieron / Abrieron el RSVP.</div>
      </div>
    </div>

    <div class="progressWrap">
      <div class="progressRow">
        <div>
          <div class="label" style="margin-bottom:4px">Avance de respuestas</div>
          <div class="kpiLine"><b id="kpi_pct">‚Äî%</b> ¬∑ faltan <b id="kpi_left">‚Äî</b> invitaciones</div>
          <div class="kpiLine muted">Pases pendientes estimados: <b id="kpi_pases_left">‚Äî</b></div>
        </div>
        <div class="row">
          <span class="tag">Pendientes primero</span>
          <span class="tag">Filtro por apertura</span>
        </div>
      </div>
      <div class="progressBar" aria-label="Progreso">
        <div class="progressFill" id="progressFill"></div>
      </div>
    </div>

    <div class="controls">
      <input id="q" type="search" placeholder="Buscar por nombre‚Ä¶">
      <select id="f">
        <option value="all">Todos</option>
        <option value="Pendiente">Pendientes</option>
        <option value="Confirmado">Confirmados</option>
        <option value="No asistir√°">No asistir√°n</option>
      </select>

      <select id="fo">
        <option value="all">Apertura: Todos</option>
        <option value="opened">Apertura: Abrieron</option>
        <option value="not_opened">Apertura: No han abierto</option>
      </select>

      <button class="btn" id="reload">Actualizar</button>
      <button class="btn secondary" id="csv">Descargar CSV</button>
    </div>
  </div>

  <div id="out"></div>
</div>

<script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzzuYdqWMgo8UJjXqm-rJETAnRyFeklo7m03s7gb7ehEL2ueiearC253nHcfwptNvnw/exec"; // <-- pega tu /exec
  const params = new URLSearchParams(location.search);
  const admin = params.get('admin') || '';

  const $ = id => document.getElementById(id);
  let state = { items:[], counts:{}, totals:{} };

  function escapeHtml(s){
    return (s??'').toString()
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function statusClass(s){
    if (s === 'Confirmado') return 'ok';
    if (s === 'No asistir√°') return 'no';
    return 'wait';
  }

  // Convierte "yyyy-MM-dd HH:mm" a Date (sin TZ; suficiente para "hace X d√≠as")
  function parseUpdated(s){
    if(!s) return null;
    const t = String(s).trim().replace(' ', 'T');
    const d = new Date(t);
    return isNaN(d.getTime()) ? null : d;
  }
  function daysAgo(s){
    const d = parseUpdated(s);
    if(!d) return '';
    const now = new Date();
    const diff = now.getTime() - d.getTime();
    const days = Math.floor(diff / (1000*60*60*24));
    if(days <= 0) return 'hoy';
    if(days === 1) return 'hace 1 d√≠a';
    return `hace ${days} d√≠as`;
  }

  function render(){
    const t = state.totals || {};
    const totalReg = Number(t.totalRegistros ?? 0);
    const responded = Number(t.respondedCount ?? 0);
    const totalPases = Number(t.totalPases ?? 0);
    const pasesPend = Number(t.personasPendientes ?? 0);

    $('t_reg').textContent = totalReg;
    $('t_pases').textContent = totalPases;
    $('t_p_ok').textContent = Number(t.personasConfirmadas ?? 0);
    $('t_p_no').textContent = Number(t.personasNo ?? 0);
    $('t_p_wait').textContent = pasesPend;
    $('t_resp').textContent = responded;
    $('t_open').textContent = Number(t.openedCount ?? 0);

    const left = Math.max(totalReg - responded, 0);
    const pct = totalReg > 0 ? Math.round((responded / totalReg) * 100) : 0;
    $('kpi_pct').textContent = `${pct}%`;
    $('kpi_left').textContent = left;
    $('kpi_pases_left').textContent = pasesPend;
    $('progressFill').style.width = `${pct}%`;

    const q = ($('q').value || '').toLowerCase().trim();
    const f = $('f').value;
    const fo = $('fo').value;

    const filtered = (state.items || []).filter(it => {
      const okName = (it.nombre || '').toLowerCase().includes(q);
      const okStatus = (f === 'all') ? true : (it.status === f);
      const okOpen =
        fo === 'all' ? true :
        fo === 'opened' ? !!it.opened :
        fo === 'not_opened' ? !it.opened : true;
      return okName && okStatus && okOpen;
    });

    if (!admin){
      $('out').innerHTML = `<div class="error"><b>Acceso restringido.</b><br>Abre con <code>?admin=TU_TOKEN</code></div>`;
      return;
    }

    if (!filtered.length){
      $('out').innerHTML = `<div class="empty">No hay resultados con ese filtro.</div>`;
      return;
    }

    $('out').innerHTML = `
      <div class="grid">
        ${filtered.map(it => {
          const itin = (it.vuelo || '').toString().trim();
          const msg = (it.comentarios || '').toString().trim();
          const hasDetails = !!(itin || msg);
          const ago = daysAgo(it.updated || '');

          return `
          <div class="card">
            <div class="status ${statusClass(it.status)}">${escapeHtml(it.status)}</div>
            <div class="open-badge">${it.opened ? 'Abri√≥ RSVP' : 'No ha abierto'}</div>

            <div class="name">${escapeHtml(it.nombre || '')}</div>

            <div class="meta">
              üéüÔ∏è <b>${escapeHtml(String(it.pases ?? ''))}</b> pases<br>
              üë• Acompa√±antes: ${escapeHtml(it.invitados || '‚Äî')}
            </div>

            <div class="small">
              √öltima actualizaci√≥n: ${escapeHtml(it.updated || '‚Äî')}
              ${ago && it.updated ? ` ¬∑ <b>${escapeHtml(ago)}</b>` : ''}
            </div>

            ${hasDetails ? `
              <details>
                <summary>Ver detalles</summary>

                ${itin ? `
                  <div class="detailLabel">Itinerario / Asistencia</div>
                  <div class="detailText">${escapeHtml(itin)}</div>
                ` : ''}

                ${msg ? `
                  <div class="detailLabel">Mensaje adicional</div>
                  <div class="detailText">${escapeHtml(msg)}</div>
                ` : ''}
              </details>
            ` : ''}
          </div>`;
        }).join('')}
      </div>
    `;
  }

  async function load(){
    if(!WEBAPP_URL.includes('http')){
      $('out').innerHTML = `<div class="error">Configura <b>WEBAPP_URL</b> en este archivo.</div>`;
      return;
    }
    if(!admin){
      render();
      return;
    }

    $('out').innerHTML = `<div class="empty">Cargando‚Ä¶</div>`;
    try{
      const url = `${WEBAPP_URL}?action=adminDashboard&admin=${encodeURIComponent(admin)}`;
      const res = await fetch(url);
      const data = await res.json();
      if(!data.ok){
        $('out').innerHTML = `<div class="error">${escapeHtml(data.error || 'Error')}</div>`;
        return;
      }
      state = data;
      render();
    }catch(e){
      $('out').innerHTML = `<div class="error">Error de conexi√≥n.</div>`;
    }
  }

  function downloadCsv(){
    if(!admin) return;
    const url = `${WEBAPP_URL}?action=exportCsv&admin=Xul@peluch3${encodeURIComponent(admin)}`;
    window.open(url, '_blank');
  }

  $('q').addEventListener('input', render);
  $('f').addEventListener('change', render);
  $('fo').addEventListener('change', render);
  $('reload').addEventListener('click', load);
  $('csv').addEventListener('click', downloadCsv);

  load();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Â· Confirmaciones RSVP</title>

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Lato:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --arena:#E7DCCB;
      --duna:#CDBDA7;
      --mar:#5AA7C7;
      --ok:#6fbf8a;
      --no:#d97c7c;
      --wait:#9a9a9a;
      --text:#2f2f2f;
      --card:rgba(255,255,255,.94);
      --shadow:0 18px 45px rgba(0,0,0,.12);
      --radius:18px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      min-height:100vh;
      font-family:"Lato",sans-serif;
      color:var(--text);
      background:radial-gradient(circle at top,#fff 0%,var(--arena) 48%,var(--duna) 100%);
      padding:22px;
    }

    .wrap{max-width:1150px;margin:auto}

    /* HEADER */
    .top{
      background:var(--card);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:22px 20px 18px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }

    .top::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(90,167,199,.22),rgba(205,189,167,.14));
      opacity:.7;
      pointer-events:none;
    }

    .top>*{position:relative;z-index:1}

    .names{
      font-family:"Dancing Script",cursive;
      font-size:2.8rem;
      margin:0;
      color:var(--mar);
    }

    .subtitle{
      margin:6px 0 12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size:.85rem;
      color:rgba(47,47,47,.7);
    }

    /* RESUMEN */
    .summary{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .pill{
      padding:10px 16px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(205,189,167,.9);
      box-shadow:0 10px 22px rgba(0,0,0,.07);
      font-size:.95rem;
    }

    .pill b{font-size:1.1rem}
    .pill.ok b{color:var(--ok)}
    .pill.no b{color:var(--no)}
    .pill.wait b{color:var(--wait)}

    /* CONTROLES */
    .controls{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    input,select{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(205,189,167,.95);
      background:#fff;
      outline:none;
      min-width:220px;
      font-size:.95rem;
    }

    button{
      padding:10px 18px;
      border-radius:999px;
      border:0;
      background:var(--mar);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 12px 26px rgba(90,167,199,.35);
    }

    button:hover{filter:brightness(.95)}

    /* LISTA */
    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:14px;
    }

    .card{
      background:var(--card);
      border-radius:16px;
      padding:14px 14px 12px;
      box-shadow:0 14px 32px rgba(0,0,0,.10);
      position:relative;
    }

    .status{
      position:absolute;
      top:12px;
      right:12px;
      padding:6px 12px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:700;
    }

    .status.ok{background:rgba(111,191,138,.18);color:var(--ok)}
    .status.no{background:rgba(217,124,124,.18);color:var(--no)}
    .status.wait{background:rgba(154,154,154,.18);color:var(--wait)}

    .name{
      font-weight:700;
      font-size:1.05rem;
      margin:14px 0 6px;
      padding-right:90px;
    }

    .meta{
      font-size:.9rem;
      line-height:1.45;
      color:rgba(47,47,47,.75);
    }

    .small{
      margin-top:8px;
      font-size:.8rem;
      color:rgba(47,47,47,.65);
    }

    .empty,.error{
      margin-top:18px;
      background:var(--card);
      border-radius:var(--radius);
      padding:16px;
      text-align:center;
      box-shadow:var(--shadow);
    }

    .error{border:1px solid rgba(217,124,124,.4)}

    @media(max-width:480px){
      .names{font-size:2.3rem}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <h1 class="names">Cynthia &amp; JosÃ© Miguel</h1>
    <div class="subtitle">Panel administrador Â· Confirmaciones RSVP</div>

    <div class="summary">
      <div class="pill ok">Confirmados: <b id="c_ok">â€”</b></div>
      <div class="pill no">No asistirÃ¡n: <b id="c_no">â€”</b></div>
      <div class="pill wait">Pendientes: <b id="c_wait">â€”</b></div>
    </div>

    <div class="controls">
      <input id="q" type="search" placeholder="Buscar por nombreâ€¦">
      <select id="f">
        <option value="all">Todos</option>
        <option value="Pendiente">Pendientes</option>
        <option value="Confirmado">Confirmados</option>
        <option value="No asistirÃ¡">No asistirÃ¡n</option>
      </select>
      <button id="reload">Actualizar</button>
    </div>
  </div>

  <div id="out"></div>

</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzzuYdqWMgo8UJjXqm-rJETAnRyFeklo7m03s7gb7ehEL2ueiearC253nHcfwptNvnw/exec"; // â† IMPORTANTE

const params = new URLSearchParams(location.search);
const admin = params.get('admin') || '';

const $ = id => document.getElementById(id);
let state = { items:[], counts:{confirmados:0,no:0,pendientes:0} };

function statusClass(s){
  if(s==='Confirmado') return 'ok';
  if(s==='No asistirÃ¡') return 'no';
  return 'wait';
}

function escapeHtml(s){
  return (s??'').toString()
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function render(){
  $('c_ok').textContent = state.counts.confirmados || 0;
  $('c_no').textContent = state.counts.no || 0;
  $('c_wait').textContent = state.counts.pendientes || 0;

  const q = $('q').value.toLowerCase().trim();
  const f = $('f').value;

  const filtered = state.items.filter(it=>{
    const okName = (it.nombre||'').toLowerCase().includes(q);
    const okFilter = f==='all' ? true : it.status===f;
    return okName && okFilter;
  });

  if(!admin){
    $('out').innerHTML = `<div class="error"><b>Acceso restringido.</b><br>Agrega <code>?admin=TU_TOKEN</code> a la URL.</div>`;
    return;
  }

  if(!filtered.length){
    $('out').innerHTML = `<div class="empty">No hay resultados con ese filtro.</div>`;
    return;
  }

  $('out').innerHTML = `
    <div class="grid">
      ${filtered.map(it=>`
        <div class="card">
          <div class="status ${statusClass(it.status)}">${it.status}</div>
          <div class="name">${escapeHtml(it.nombre)}</div>
          <div class="meta">
            ðŸ‘¥ <b>${escapeHtml(it.invitados)}</b> invitados<br>
            ðŸ’¬ ${escapeHtml(it.comentarios || 'â€”')}
          </div>
          <div class="small">Ãšltima actualizaciÃ³n: ${escapeHtml(it.updated || 'â€”')}</div>
        </div>
      `).join('')}
    </div>`;
}

async function load(){
  if(!WEBAPP_URL.includes('http')){
    $('out').innerHTML = `<div class="error">Configura <b>WEBAPP_URL</b> en el archivo.</div>`;
    return;
  }

  $('out').innerHTML = `<div class="empty">Cargando confirmacionesâ€¦</div>`;
  try{
    const res = await fetch(`${WEBAPP_URL}?action=adminDashboard&admin=${encodeURIComponent(admin)}`);
    const data = await res.json();
    if(!data.ok){
      $('out').innerHTML = `<div class="error">${escapeHtml(data.error||'Error')}</div>`;
      return;
    }
    state = data;
    render();
  }catch(err){
    $('out').innerHTML = `<div class="error">Error de conexiÃ³n</div>`;
  }
}

$('q').addEventListener('input',render);
$('f').addEventListener('change',render);
$('reload').addEventListener('click',load);

load();
</script>

</body>
</html>

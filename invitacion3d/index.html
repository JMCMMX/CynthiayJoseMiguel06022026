<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Invitación Boda - Pase de Abordar 3D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #2b3a4a, #050810);
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .wrapper {
      width: 100%;
      max-width: 900px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    h1 {
      font-size: 1.2rem;
      font-weight: 500;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      text-align: center;
      margin: 8px 0;
      opacity: 0.9;
    }
    .sub {
      font-size: 0.85rem;
      text-align: center;
      opacity: 0.8;
      max-width: 500px;
    }
    #canvas-container {
      width: 100%;
      aspect-ratio: 16 / 9;
      max-height: 480px;
      margin-top: 8px;
      border-radius: 18px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      background: radial-gradient(circle at center, #132032, #050810);
    }
    canvas {
      display: block;
    }
    .info-card {
      margin-top: 8px;
      padding: 12px 16px;
      border-radius: 14px;
      background: rgba(5, 8, 16, 0.85);
      border: 1px solid rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      display: flex;
      flex-direction: column;
      gap: 4px;
      width: 100%;
      max-width: 600px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      flex-wrap: wrap;
      gap: 8px;
    }
    .label {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.7rem;
      opacity: 0.7;
    }
    .value {
      font-weight: 600;
    }
    .secondary {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 4px;
    }
    .hint {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 2px;
    }
    .error {
      margin-top: 16px;
      color: #ffb3b3;
      font-size: 0.9rem;
      text-align: center;
    }
    #baseTicket {
      display: none;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Pase de abordar &mdash; Boda Cynthia &amp; José Miguel</h1>
    <p class="sub">
      Arrastra con el dedo o el mouse para girar tu boleto.  
      Esta invitación es personal y está hecha solo para ti ✈️
    </p>

    <div id="canvas-container"></div>

    <div class="info-card" id="info-card">
      <div class="info-row">
        <div>
          <div class="label">Pasajero</div>
          <div class="value" id="info-nombre">Invitado especial</div>
        </div>
        <div>
          <div class="label">Ruta</div>
          <div class="value">
            <span id="info-desde">Ciudad Origen</span>
            &nbsp;&rarr;&nbsp;
            <span id="info-hacia">Playa del Carmen</span>
          </div>
        </div>
      </div>
      <div class="info-row">
        <div>
          <div class="label">Fecha</div>
          <div class="value">06 febrero 2026 &bull; 18:00 h</div>
        </div>
        <div>
          <div class="label">Destino</div>
          <div class="value">Playa del Carmen, México</div>
        </div>
      </div>
      <div class="secondary">
        Presenta este pase digital al llegar &mdash; tu enlace es único y personal.
      </div>
      <div class="hint">
        Tip: gira el celular en horizontal para verlo más grande.
      </div>
    </div>

    <div class="error" id="error-msg" style="display:none;"></div>
  </div>

  <!-- Imagen base del boleto (la textura) -->
  <img id="baseTicket" src="boleto-base.png" alt="Boleto base">

  <!-- Three.js desde CDN -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

  <script>
    /***** CONFIG: URL de tu Apps Script *****/
    // Pega aquí la URL de implementación del web app (termina en /exec)
    const API_URL = 'https://script.google.com/macros/s/AKfycbzBtlmIjacWcpdhzd8pnyhvL_mQtj8arptSGXeu5vYosB1PWb788D1lsXaO6FXNTU_B/exec';

    function getTokenFromURL() {
      const params = new URLSearchParams(window.location.search);
      return (params.get('t') || params.get('token') || '').trim();
    }

    async function fetchInvitado(token) {
      if (!token) return null;
      const url = API_URL + '?token=' + encodeURIComponent(token);
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Error HTTP: ' + resp.status);
      const data = await resp.json();
      if (!data.ok) throw new Error(data.error || 'Token no encontrado');
      return data.data; // { token, nombre, desde, hacia }
    }

    window.addEventListener('load', async () => {
      const errorMsg = document.getElementById('error-msg');
      const infoNombre = document.getElementById('info-nombre');
      const infoDesde = document.getElementById('info-desde');
      const infoHacia = document.getElementById('info-hacia');
      const baseImg = document.getElementById('baseTicket');

      const token = getTokenFromURL();
      let invitado = null;

      try {
        invitado = await fetchInvitado(token);
      } catch (err) {
        console.error(err);
        errorMsg.style.display = 'block';
        errorMsg.textContent = 'No se pudo cargar tu invitación. Verifica el enlace o contacta a los novios. (' + err.message + ')';
      }

      if (invitado) {
        infoNombre.textContent = invitado.nombre || 'Invitado especial';
        infoDesde.textContent = invitado.desde || 'Origen';
        infoHacia.textContent = invitado.hacia || 'Destino';
      }

      if (!baseImg.complete) {
        baseImg.onload = () => startThree(invitado, baseImg);
      } else {
        startThree(invitado, baseImg);
      }
    });

    function startThree(invitado, baseImg) {
      const container = document.getElementById('canvas-container');

      const canvasTex = document.createElement('canvas');
      const ctx = canvasTex.getContext('2d');
      canvasTex.width = baseImg.naturalWidth;
      canvasTex.height = baseImg.naturalHeight;

function dibujarBoleto(data) {
  ctx.clearRect(0, 0, canvasTex.width, canvasTex.height);
  ctx.drawImage(baseImg, 0, 0, canvasTex.width, canvasTex.height);

  if (!data) return;

  ctx.fillStyle = '#222222';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'middle';

  // El PNG original es 2000 x 700
  const scaleX = canvasTex.width / 2000;
  const scaleY = canvasTex.height / 700;

  // ===============================
  // 1) NOMBRE DEL PASAJERO
  // ===============================
  // Punto de inicio del nombre (justo después de "NOMBRE DEL PASAJERO:")
  const xNombreBase = 570;   // px en la imagen 2000x700
  const yNombreBase = 585;   // ligeramente encima del borde inferior

  const xNombre = xNombreBase * scaleX;
  const yNombre = yNombreBase * scaleY;

  const nombre = (data.nombre || '').toUpperCase();

  // Ancho máximo disponible para el nombre (hasta casi el borde derecho)
  const maxNombreWidth = (1900 - xNombreBase) * scaleX;

  // Ajuste dinámico del tamaño de fuente para nombres largos
  let fontSizeNombre = 30 * scaleY; // tamaño base
  while (true) {
    ctx.font = `${fontSizeNombre}px "Lato", system-ui, sans-serif`;
    const widthText = ctx.measureText(nombre).width;
    if (widthText <= maxNombreWidth || fontSizeNombre <= 16 * scaleY) {
      break;
    }
    fontSizeNombre -= 1 * scaleY;
  }
  ctx.fillText(nombre, xNombre, yNombre);

  // ===============================
  // 2) DE y A (panel derecho)
  // ===============================
  const desde = (data.desde || '').toUpperCase();
  const hacia = (data.hacia || '').toUpperCase();

  // Coordenadas para DE: y A: (alineados con tus etiquetas en el PNG)
  const xDesdeBase = 1605;  // un poco a la derecha de "DE:"
  const yDesdeBase = 290;   // altura alineada con las etiquetas

  const xHaciaBase = 1870;  // un poco a la derecha de "A:"
  const yHaciaBase = 290;

  const xDesde = xDesdeBase * scaleX;
  const yDesde = yDesdeBase * scaleY;

  const xHacia = xHaciaBase * scaleX;
  const yHacia = yHaciaBase * scaleY;

  ctx.font = `${22 * scaleY}px "Lato", system-ui, sans-serif`;
  ctx.fillText(desde, xDesde, yDesde);
  ctx.fillText(hacia, xHacia, yHacia);
}



      dibujarBoleto(invitado);

      const texture = new THREE.CanvasTexture(canvasTex);

      const scene = new THREE.Scene();
      scene.background = null;

      const fov = 35;
      const aspect = container.clientWidth / container.clientHeight;
      const camera = new THREE.PerspectiveCamera(fov, aspect, 0.1, 100);
      camera.position.set(0, 0.1, 3.2);

      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      const ambient = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambient);

      const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
      dirLight.position.set(2, 4, 3);
      scene.add(dirLight);

      const backLight = new THREE.DirectionalLight(0xffffff, 0.4);
      backLight.position.set(-2, -3, -2);
      scene.add(backLight);

      const imgAspect = canvasTex.width / canvasTex.height;
      const planeHeight = 1.4;
      const planeWidth = planeHeight * imgAspect;

      const geometry = new THREE.PlaneGeometry(planeWidth, planeHeight, 1, 1);
      const material = new THREE.MeshStandardMaterial({
        map: texture,
        roughness: 0.35,
        metalness: 0.05,
        side: THREE.DoubleSide
      });

      const plane = new THREE.Mesh(geometry, material);
      plane.rotation.x = -0.15;
      plane.rotation.y = 0.4;
      scene.add(plane);

      let isDragging = false;
      let previousMousePosition = { x: 0, y: 0 };
      let autoRotate = true;

      function onPointerDown(e) {
        isDragging = true;
        autoRotate = false;
        previousMousePosition = {
          x: e.clientX || (e.touches?.[0]?.clientX || 0),
          y: e.clientY || (e.touches?.[0]?.clientY || 0)
        };
      }

      function onPointerMove(e) {
        if (!isDragging) return;
        const x = e.clientX || (e.touches?.[0]?.clientX || 0);
        const y = e.clientY || (e.touches?.[0]?.clientY || 0);

        const deltaMove = {
          x: x - previousMousePosition.x,
          y: y - previousMousePosition.y
        };

        plane.rotation.y += deltaMove.x * 0.005;
        plane.rotation.x += deltaMove.y * 0.005;

        previousMousePosition = { x, y };
      }

      function onPointerUp() {
        isDragging = false;
        setTimeout(() => { autoRotate = true; }, 2000);
      }

      renderer.domElement.addEventListener('mousedown', onPointerDown);
      renderer.domElement.addEventListener('mousemove', onPointerMove);
      window.addEventListener('mouseup', onPointerUp);

      renderer.domElement.addEventListener('touchstart', onPointerDown, { passive: true });
      renderer.domElement.addEventListener('touchmove', onPointerMove, { passive: true });
      window.addEventListener('touchend', onPointerUp);

      window.addEventListener('resize', () => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      });

      function animate() {
        requestAnimationFrame(animate);
        if (autoRotate) {
          plane.rotation.y += 0.003;
        }
        texture.needsUpdate = true;
        renderer.render(scene, camera);
      }
      animate();
    }
  </script>
</body>
</html>

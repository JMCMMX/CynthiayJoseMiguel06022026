<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Confirmaci√≥n de asistencia - Boda Cynthia y Jos√© Miguel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: "Lato", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #e7dccb, #cdbda7);
    }
    .container {
      width: 100%;
      max-width: 520px;
      margin: 16px;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      padding: 24px 20px 20px;
    }
    h1 {
      font-size: 1.3rem;
      margin: 0 0 4px;
      text-align: center;
      letter-spacing: 0.13em;
      text-transform: uppercase;
     	color: #4b4b4b;
    }
    h2 {
      font-size: 1.1rem;
      margin: 4px 0 8px;
      text-align: center;
      font-weight: 400;
      color: #666;
    }
    .chip {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #5aa7a7;
      color: #fff;
      font-size: 0.8rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin: 0 auto 10px;
      text-align: center;
      display: block;
      max-width: 120px;
    }
    .section-title {
      font-size: 0.9rem;
      font-weight: 700;
      margin: 14px 0 6px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #555;
    }
    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #666;
    }
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d0c4b5;
      font-size: 0.9rem;
      font-family: inherit;
      resize: vertical;
    }
    textarea { min-height: 70px; }
    .small-hint {
      font-size: 0.75rem;
      color: #999;
      margin-top: 4px;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1;
      min-width: 120px;
    }
    .button-row {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.3s ease;
    }
    button[type="submit"] {
      background: linear-gradient(135deg, #5aa7a7, #3c7e7e);
      color: #fff;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    button[type="button"] {
      background: #f2ebe1;
      color: #555;
      border: 1px solid #d3c4b0;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.18);
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .status {
      margin-top: 10px;
      font-size: 0.85rem;
      text-align: center;
    }
    .status.ok { color: #2e7d32; }
    .status.error { color: #c62828; }
    .tagline {
      font-size: 0.78rem;
      text-align: center;
      margin-top: 10px;
      color: #999;
    }
    .passes-info {
      font-size: 0.8rem;
      text-align: center;
      color: #777;
      margin-bottom: 10px;
    }

    /* ====== NUEVO: Badge animado de pases (solo visual) ====== */
    .passes-badge-wrap{
      display:flex;
      justify-content:center;
      margin: 6px 0 10px;
    }
    .passes-badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(90,167,167,0.18), rgba(60,126,126,0.10));
      border: 1px solid rgba(90,167,167,0.35);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      transform: translateY(-6px) scale(0.98);
      opacity: 0;
      animation: badgeIn 650ms cubic-bezier(.2,.9,.2,1) forwards;
    }
    .passes-dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: #5aa7a7;
      box-shadow: 0 0 0 0 rgba(90,167,167,0.55);
      animation: pulse 1.4s ease-in-out infinite;
    }
    .passes-text{
      line-height: 1.05;
      text-align:left;
    }
    .passes-text .top{
      font-size: 0.72rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color:#3c7e7e;
      font-weight:700;
    }
    .passes-text .big{
      font-size: 0.98rem;
      color:#4b4b4b;
      font-weight:700;
      margin-top:2px;
    }
    .passes-text .sub{
      font-size: 0.78rem;
      color:#666;
      margin-top:2px;
    }
    @keyframes badgeIn{
      0%{ transform: translateY(-10px) scale(0.96); opacity:0; }
      100%{ transform: translateY(0) scale(1); opacity:1; }
    }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 rgba(90,167,167,0.55); }
      70%{ box-shadow: 0 0 0 10px rgba(90,167,167,0); }
      100%{ box-shadow: 0 0 0 0 rgba(90,167,167,0); }
    }
    /* ====== FIN NUEVO ====== */
  </style>
</head>
<body>
  <div class="container">
    <span class="chip">RSVP</span>
    <h1>Confirmaci√≥n de asistencia</h1>
    <h2 id="title-nombre">Cargando invitado...</h2>

    <!-- ====== NUEVO: indicador animado de pases ====== -->
    <div class="passes-badge-wrap" aria-live="polite">
      <div class="passes-badge" id="passes-badge" style="display:none;">
        <span class="passes-dot" aria-hidden="true"></span>
        <div class="passes-text">
          <div class="top">Pases en tu invitaci√≥n</div>
          <div class="big" id="passes-badge-big">‚Äî</div>
          <div class="sub" id="passes-badge-sub">‚Äî</div>
        </div>
      </div>
    </div>
    <!-- ====== FIN NUEVO ====== -->

    <p id="pases-info" class="passes-info"></p>

    <form id="rsvp-form">
      <div class="section-title">Asistencia</div>
      <label for="asistencia">
        ¬øPodr√°s acompa√±arnos?
      </label>
      <select id="asistencia" name="asistencia" required>
        <option value="">Selecciona una opci√≥n</option>
        <option value="SI">S√≠, con mucho gusto</option>
        <option value="NO">No podr√© asistir</option>
        <option value="INDECISO">A√∫n no estoy seguro</option>
      </select>

      <div class="section-title">Invitados que te acompa√±an</div>
      <label for="invitados">
        Nombre completo (igual que en su identificaci√≥n) de quienes asistir√°n contigo 
      </label>
     <textarea id="invitados" name="invitados" placeholder="Ejemplo:&#10;1. Juan P√©rez&#10;2. Mar√≠a L√≥pez"></textarea>
      <div class="small-hint" id="invitados-hint">
        Si tu invitaci√≥n incluye acompa√±antes, escribe aqu√≠ sus nombres completos (uno por l√≠nea), si no incluye acompa√±antes deja en blanco este campo.
      </div>

      <div class="section-title">Itinerario de vuelo (Opcional) </div>
      <label for="vuelo">
        Cu√©ntanos c√≥mo y cu√°ndo llegas
      </label>
      <textarea id="vuelo" name="vuelo" placeholder="Ejemplo:&#10;Vuelo: AM123 CDMX ‚Üí CUN&#10;Fecha llegada: 05 de febrero 2026, 14:30&#10;Hotel: Occidental Xcaret">
      </textarea>
      <div class="small-hint">
        Esto nos ayudar√° a coordinarnos mejor para cualquier apoyo de transporte o seguimiento.
      </div>

      <div class="section-title">Comentarios adicionales</div>
      <label for="comentarios">
        ¬øAlgo m√°s que debamos saber?
      </label>
      <textarea id="comentarios" name="comentarios" placeholder="Alergias, restricciones alimenticias, necesidades especiales, etc.">
      </textarea>

      <div class="button-row">
        <button type="submit" id="btn-enviar">Enviar confirmaci√≥n</button>
        <button type="button" id="btn-volver">Ver pase de abordar 3D</button>
      </div>
      <div id="status" class="status"></div>
      <div class="tagline">
        Gracias por tomarte el tiempo de llenar estos datos üíö
      </div>
    </form>
  </div>

  <script>
    // === CONFIGURACI√ìN ===
    const API_URL = 'https://script.google.com/macros/s/AKfycbzzuYdqWMgo8UJjXqm-rJETAnRyFeklo7m03s7gb7ehEL2ueiearC253nHcfwptNvnw/exec'; // üëà MISMA URL /exec del Apps Script
    const URL_3D  = 'https://cynthiayjosemiguel.com.mx/invitacion3d/';    // donde tienes el modelo 3D

    function getTokenFromURL() {
      const params = new URLSearchParams(window.location.search);
      return (params.get('t') || params.get('token') || '').trim();
    }

    async function fetchInvitado(token) {
      if (!token) return null;
      const url = API_URL + '?token=' + encodeURIComponent(token);
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      if (!data.ok) throw new Error(data.error || 'Token no encontrado');
      return data.data; // { token, nombre, desde, hacia, pases }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const token = getTokenFromURL();
      const titleNombre = document.getElementById('title-nombre');
      const form        = document.getElementById('rsvp-form');
      const statusEl    = document.getElementById('status');
      const btnEnviar   = document.getElementById('btn-enviar');
      const btnVolver   = document.getElementById('btn-volver');
      const pasesInfoEl = document.getElementById('pases-info');
      const invitadosHint = document.getElementById('invitados-hint');
      const invitadosText = document.getElementById('invitados');

      // ====== NUEVO: refs del badge de pases ======
      const passesBadge = document.getElementById('passes-badge');
      const passesBadgeBig = document.getElementById('passes-badge-big');
      const passesBadgeSub = document.getElementById('passes-badge-sub');
      // ====== FIN NUEVO ======

      if (!token) {
        titleNombre.textContent = 'Invitaci√≥n no v√°lida';
        form.style.display = 'none';
        pasesInfoEl.textContent = '';
        return;
      }

      // Cargar nombre y pases desde Apps Script
      let pases = 1;
      try {
        const invitado = await fetchInvitado(token);
        const nombre = invitado.nombre || 'Invitado especial';
        pases = Number(invitado.pases || 1);
        if (isNaN(pases) || pases < 1) pases = 1;

        const maxAcomp = Math.max(pases - 1, 0);

        titleNombre.textContent = nombre;
        form.dataset.nombreInvitado = nombre;
        form.dataset.pases = String(pases);

        // ====== NUEVO: mostrar badge animado de pases ======
        passesBadge.style.display = 'inline-flex';
        const totalTxt = `${pases} pase${pases===1?'':'s'}`;
        const subTxt = (pases <= 1)
          ? 'Invitaci√≥n individual (solo t√∫).'
          : `Incluye: t√∫ + hasta ${maxAcomp} acompa√±ante${maxAcomp===1?'':'s'}.`;
        passesBadgeBig.textContent = totalTxt;
        passesBadgeSub.textContent = subTxt;
        // ====== FIN NUEVO ======

        if (pases <= 1) {
          pasesInfoEl.textContent = 'Tu invitaci√≥n es individual y no incluye acompa√±antes.';
          invitadosText.placeholder = 'Tu invitaci√≥n es individual, no es necesario agregar acompa√±antes.';
        } else {
          pasesInfoEl.textContent =
            `Tu invitaci√≥n incluye ${pases} pase${pases===1?'':'s'} en total (t√∫ + hasta ${maxAcomp} acompa√±ante${maxAcomp===1?'':'s'}).`;
          invitadosHint.textContent =
            `Puedes registrar hasta ${maxAcomp} acompa√±ante${maxAcomp===1?'':'s'}, uno por l√≠nea.`;
        }
      } catch (err) {
        console.error(err);
        titleNombre.textContent = 'No pudimos encontrar tu invitaci√≥n';
        statusEl.textContent = 'Verifica que el enlace est√© completo o cont√°ctanos.';
        statusEl.className = 'status error';
        form.style.display = 'none';
        return;
      }

      // ====== NUEVO: confirmaci√≥n de nombres (ID) al capturar ======
      function confirmacionNombresID_() {
        const raw = (invitadosText.value || '').trim();
        if (!raw) return true; // si est√° vac√≠o, no molestamos

        return window.confirm(
          'Importante: ¬øSeguro que el/los nombre(s) est√°(n) escrito(s) EXACTAMENTE igual que en su identificaci√≥n oficial?\n\n' +
          'Esto debe coincidir, ya que se validar√° en Xcaret.'
        );
      }

      // Cuando el usuario salga del campo (blur) y haya escrito algo, mostramos aviso
      invitadosText.addEventListener('blur', () => {
        const raw = (invitadosText.value || '').trim();
        if (!raw) return;
        // si cancela, regresamos foco para que corrija
        const ok = confirmacionNombresID_();
        if (!ok) {
          setTimeout(() => invitadosText.focus(), 0);
        }
      });
      // ====== FIN NUEVO ======

      // Bot√≥n para volver al pase 3D
      btnVolver.addEventListener('click', () => {
        const url = URL_3D + '?t=' + encodeURIComponent(token);
        window.location.href = url;
      });

      // Env√≠o del formulario
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        statusEl.textContent = '';
        statusEl.className = 'status';

        btnEnviar.disabled = true;
        btnEnviar.textContent = 'Enviando...';

        const asistencia = document.getElementById('asistencia').value;
        let invitados  = document.getElementById('invitados').value.trim();
        const vuelo      = document.getElementById('vuelo').value.trim();
        const comentarios= document.getElementById('comentarios').value.trim();
        const nombreInv  = form.dataset.nombreInvitado || '';
        const pasesForm  = Number(form.dataset.pases || '1');
        const maxAcomp   = Math.max(pasesForm - 1, 0);

        if (!asistencia) {
          statusEl.textContent = 'Selecciona si podr√°s asistir.';
          statusEl.className = 'status error';
          btnEnviar.disabled = false;
          btnEnviar.textContent = 'Enviar confirmaci√≥n';
          return;
        }

        // Procesar lista de acompa√±antes: uno por l√≠nea
        let lista = invitados
          .split('\n')
          .map(l => l.trim())
          .filter(l => l.length > 0);

        if (pasesForm <= 1 && lista.length > 0) {
          statusEl.textContent = 'Tu invitaci√≥n es individual; no puedes registrar acompa√±antes.';
          statusEl.className = 'status error';
          btnEnviar.disabled = false;
          btnEnviar.textContent = 'Enviar confirmaci√≥n';
          return;
        }

        if (lista.length > maxAcomp) {
          statusEl.textContent =
            `Tu invitaci√≥n permite hasta ${maxAcomp} acompa√±ante${maxAcomp===1?'':'s'}. ` +
            `Actualmente has escrito ${lista.length}. Ajusta la lista e int√©ntalo de nuevo.`;
          statusEl.className = 'status error';
          btnEnviar.disabled = false;
          btnEnviar.textContent = 'Enviar confirmaci√≥n';
          return;
        }

        // ====== NUEVO: confirmaci√≥n antes de enviar si hay nombres ======
        if (lista.length > 0) {
          const ok = confirmacionNombresID_();
          if (!ok) {
            statusEl.textContent = 'Revisa los nombres y aseg√∫rate de que coincidan con la identificaci√≥n.';
            statusEl.className = 'status error';
            btnEnviar.disabled = false;
            btnEnviar.textContent = 'Enviar confirmaci√≥n';
            return;
          }
        }
        // ====== FIN NUEVO ======

        // Normalizamos el texto de invitados (limpio)
        invitados = lista.join('\n');

        // Armamos el texto de vuelo incluyendo la asistencia
        const vueloTexto = 'Asistencia: ' + asistencia + '\n\n' + vuelo;

        // Enviamos como formulario cl√°sico (x-www-form-urlencoded)
        const formData = new URLSearchParams();
        formData.append('mode', 'rsvp');
        formData.append('token', token);
        formData.append('nombre', nombreInv);
        formData.append('invitados', invitados);
        formData.append('vuelo', vueloTexto);
        formData.append('comentarios', comentarios);

        try {
          const resp = await fetch(API_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString()
          });

          if (!resp.ok) {
            throw new Error('HTTP ' + resp.status);
          }

          const data = await resp.json();
          if (!data.ok) {
            throw new Error(data.error || 'Error al guardar RSVP');
          }

          statusEl.textContent = '¬°Gracias! Hemos registrado tu confirmaci√≥n üéâ';
          statusEl.className = 'status ok';
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'Ocurri√≥ un error al guardar tu respuesta. Intenta de nuevo m√°s tarde.';
          statusEl.className = 'status error';
        } finally {
          btnEnviar.disabled = false;
          btnEnviar.textContent = 'Enviar confirmaci√≥n';
        }
      });
    });
  </script>
</body>
</html>
